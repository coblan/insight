{% extends "index.html" %}
{% load static %}
{% load jsonify %}

{% block page_content %}
<script src='{% static "js/fields.pack.js" %}'></script>
<script src='{% static "js/uis.pack.js" %}'></script>
<script type="text/javascript">
        
        heads={{ heads | jsonify }}
		row = {{ row | jsonify }}
		permits={{permits | jsonify }}
		model_permits = {{ model_permits | jsonify}}
		errors={}

        $(function () {
                haha= new Vue({
                        el:'#there',
                        data:{
                                model_permits:model_permits,
                                permits:permits,
                                sld_md_name:'',
                                kw:{
	                                heads:heads,
	                                row:row,
	                                errors:{},
                                }
                        },
                        methods:{
                                add_model_permit:function (name) {
	                                if(!name){
		                                return 
	                                }
	                                var self=this;
                                    var post_data=[{fun:'model_permit_info',name:this.sld_md_name}]
                                    $.post('',JSON.stringify(post_data),function (data) {
	                                    //var row={'can__create':false,'can__delete':false}
	                                    var heads=data.model_permit_info
	                                    //for (var i=0;i<heads.length;i++){
		                                   // var head=heads[i]
		                                   // row[head.name+'__read']=false
		                                   // row[head.name+'__write']=false
	                                    //}
                                    	permits.push({	heads:heads,
                                    					name:self.sld_md_name,
                                    					row:[],
                                    					})
                                    })
                                },
                                get_label:function (name) {
	                                var model =ex.findone(this.model_permits,{name:name})
	                                return model.label
                                	//for(var i=0;i<this.models.length;i++){
	                                //	if(this.models[i].name==name){
		                               // 	return this.models[i].label
	                                //	}
                                	//}
                                },
                                get_left_model:function () {
	                                var sld_model_names = ex.map(this.permits,function (permit) {
	                                	return permit.name
	                                })
	                                var ls =ex.filter(this.model_permits,function (model) {
		                                	return !ex.isin(model.name,sld_model_names)
		                                })
		                            return ls
                                },
                                submit:function () {
                                        var self=this;
                                        show_upload()
                                        var post_data=[{fun:'save_group_and_permit',row:this.kw.row,permits:this.permits}]
                                        $.post('',JSON.stringify(post_data),function (data) {
                                                if(data.save_group_and_permit.errors){
                                                        this.kw.errors=data.save_group_and_permit.errors
                                                }
                                   
                                                setTimeout(function () {
                                                    hide_upload()
                                                },2000)
                                        })
                                },
                        },
                })
        })

        //function win_open(url) {
        //		window.open(url,location.pathname,'height=500,width=800,resizable=yes,scrollbars=yes')
        //}
</script>
<div id='there'>
		
        <button name="test" type="button" value="val" @click='submit()'>Save</button>
        
        <field name='name' :kw='kw'></field>
        <div>
            <select name="" id="" v-model='sld_md_name'>
	            <option v-for='item in get_left_model()' :value="item.name" v-text='item.label'></option>
            </select>
            <button name="test" type="button" value="val" @click='add_model_permit(sld_md_name)'>添加</button>
        </div>
        <div  class='row'>
	        <table class='table'>
	        	<tr v-for='permit in permits'>
		        	<td><span v-text='get_label(permit.name)'></span></td>
		        	<td>
			        	<table >
				        	<tr class='select_cell'>
					        	<td><span >快捷</span></td>
					        	<td><span >整表</span></td>
					        	<td><span>查看日志</span></td>
					        	<td v-for='head in permit.heads'><span v-text='head.label'></span></td>
				        	</tr>
				        	<tr class='select_cell'>
					        	<td><input type="checkbox" name="test" value="" /></td>
					        	<td><input type="checkbox" :id="permit.name+'can__create'" value="can__create" v-model='permit.row'/>
									<label :for="permit.name+'can__create'">创建</label>
									</td>
								<td><input type="checkbox" :id="permit.name+'can__log'" value="can__log" v-model='permit.row'/>
									<label :for="permit.name+'can__log'">允许</label>
									</td>
								<td v-for='head in permit.heads'><input type="checkbox" :id="permit.name+head.name+'__read'" 
										:value="head.name+'__read'" v-model="permit.row" />
									<label :for="permit.name+head.name+'__read'">读</label>
									</td>
				        	</tr>
				        	<tr class='select_cell'>
					        	<td><input type="checkbox" value='' ></td>
					        	<td><input type="checkbox" :id="permit.name+'can__delete'"  value='can__delete' v-model='permit.row'>
							       <label :for="permit.name+'.can__delete'">删除</label>
							       </td>
							    <td></td>
							    <td v-for='head in permit.heads'><input type="checkbox" :id="permit.name+head.name+'__write'" 
						           	:value="head.name+'__write'" v-model="permit.row">
						           	<label :for="permit.name+head.name+'__write'">写</label>
						           	</td>
				        	</tr>
				        </table>  
		        	</td>
	        	</tr>
	        </table>

        </div>


</div>

<style type="text/css" media="screen" id="test">
	.row .col{
		display: inline-block;
		margin-left:10px;
	}
	.select_cell label{
		font-weight:normal;
	}
</style>

<script type="text/javascript">
        Vue.component('pure_form',{
                template:'#pure_form',
                props:['kw'],
                methods:{
                        submit:function () {
                                var self =this;
                                show_upload()
                                var post_data=[{fun:'save',row:this.kw.row}]
                                $.post('',JSON.stringify(post_data),function (data) {
                                        if(data.save.errors){
                                                self.kw.errors = data.save.errors
                                                hide_upload()
                                        }else{
                                                self.$dispatch('submit-success')
                                                setTimeout(function () {
                                                        hide_upload()
                                                }, 2000);
                                        }
                                        
                                })
                        }
                },
                events:{
                        'submit':function () {
                                this.submit()
                        }
                }
        })
</script>
<template id='pure_form'>
        <div>
                <field  v-for='head in kw.heads' :name='head.name' :kw='kw'></field>
        </div>
</template>
{% endblock %}